---
layout: post
title: "rust: rust-bitcoin と BDK (6)"
tags:
  - rust
  - bitcoin
date: "2025/10/02"
---

## BDK でトランザクションを作る

前回は BDK の example を動かしただけだった。  
そのコードを改造して rust-bitcoin で作ったように署名したトランザクションを作ろうとしている。  
今のところ、署名するコードを呼び出して失敗するところまでやってきた。

* [hirokuma/bdk-example at 5f1f5df63db384f5df31bfeb9bc2868fb62ed0c7](https://github.com/hirokuma/bdk-example/tree/5f1f5df63db384f5df31bfeb9bc2868fb62ed0c7)

Cookbook の頃とメジャーバージョンが違うせいか、[Transaction Builder](https://bookofbdk.com/cookbook/transactions/transaction-builder/) のような書き方ではなく、
`build_tx()` を別にするようだ。  
[TxBuilder in bdk_wallet - Rust](https://docs.rs/bdk_wallet/2.2.0/bdk_wallet/struct.TxBuilder.html) の例を見ていると
絶対に別にしないとダメということではないようだが、まだ私には理屈が分からん。

### ダミーUTXOが追加できない

今のコードを実行すると "UTXO not found in the internal database for txid" とエラーになる。
[`add_utxo()`](https://docs.rs/bdk_wallet/2.2.0/bdk_wallet/struct.TxBuilder.html#method.add_utxo) なのだが、
[unspent判定](https://docs.rs/bdk_wallet/2.2.0/src/bdk_wallet/wallet/tx_builder.rs.html#299) でエラーになってるんじゃなかろうか。  
まあ、オールゼロだしねぇ。

しかし Coinbaseトランザクションもあるので、指定できないこともないが、
"wallet" という意味では対応しなくてもおかしくないのか。
rust-bitcoin でやればよいだけだし。

[`add_unspendable()`](https://docs.rs/bdk_wallet/2.2.0/bdk_wallet/struct.TxBuilder.html#method.add_unspendable) は
失敗はしないが `finish()` のときに "Insufficient funds" になる。  
やっぱり "wallet" として処理しているので UTXO であることが大切なのだろう。

もう1つ [`add_foreign_utxo()`](https://docs.rs/bdk_wallet/2.2.0/bdk_wallet/struct.TxBuilder.html#method.add_foreign_utxo) もあるが
こちらは `psbt.Input` を引数に取るなど UTXO の存在が明らかになっていないといけないようだ。  
unit test で作りたいときはこっちがよいのかな？  
いや、通常は `add_utxo()` でやりたいだろうからそうではないな。。。
