---
layout: post
title: "docker: x86_64 Linux と M1 Mac"
tags:
  - other
  - bitcoin
date: "2025/12/21"
---

普段の開発は WSL2 上で行っている。つまり x86_64 というか linux/amd64 というか、そういう環境だ。  
テスト用にその環境で動く Dockerイメージを作っていたのだが、そういえば客先は Mac だったことを思い出した。
要求されているわけでもないのだが、Docker環境の方が説明も楽だしよさそうな気がした。

同じ Linux だから動くだろうとなんとなく思っていたのだが、そんなことはなかった。  
そうよね、VM じゃないんだったよね。

動かそうとしたのは bitcoind だ。
自分でビルドしたものでも、既に Docker Hub に上がっているイメージでもなく、公式からバイナリをダウンロードしてイメージを作っている。
このくらいなら許してくれるだろう(誰が?)という気持ちだ。

最初は x86_64 向けだけだったのだが、M1 Mac では rosetta2 エラーになっていた。
OS を判別すればよいだろうと思って詳しく調べていない。  
"macOS (arm64)" があったのでこれだろうとやってみたが、これはこれでファイル形式がダメだというエラーになる。  
正解は "ARM Linux" の aarch64-linux だった。

* [Bitcoin Core :: Download - Bitcoin](https://bitcoincore.org/en/download/)

`Dockerfile` はほぼ Gemini に作ってもらったので特に言うことはない。

```dockerfile
FROM --platform=$BUILDPLATFORM debian:bookworm-slim
ARG TARGETARCH

ENV BITCOIN_VERSION=30.0
ENV BITCOIN_FILE_X86=bitcoin-${BITCOIN_VERSION}-x86_64-linux-gnu.tar.gz
ENV BITCOIN_FILE_AARCH=bitcoin-${BITCOIN_VERSION}-aarch64-linux-gnu.tar.gz
ENV BITCOIN_DATA=/home/bitcoin/.bitcoin

RUN apt-get update && apt-get install -y \
    curl \
    ca-certificates \
    && apt-get clean && rm -rf /var/lib/apt/lists/* \
    && useradd -m bitcoin

RUN if [ "$TARGETARCH" = "amd64" ]; then \
        BITCOIN_FILE=${BITCOIN_FILE_X86}; \
    elif [ "$TARGETARCH" = "arm64" ]; then \
        BITCOIN_FILE=${BITCOIN_FILE_AARCH}; \
    else \
        echo "Unknown ARCH"; \
        exit 1; \
    fi && \
    BITCOIN_URL="https://bitcoincore.org/bin/bitcoin-core-${BITCOIN_VERSION}/${BITCOIN_FILE}"; \
    curl -SLO "$BITCOIN_URL" \
    && tar -xzf ${BITCOIN_FILE} -C /usr/local --strip-components=1 --exclude='*-qt' \
    && rm ${BITCOIN_FILE}

USER bitcoin
RUN mkdir -p ${BITCOIN_DATA}
WORKDIR /home/bitcoin
EXPOSE 18444 18443
CMD ["bitcoind", "-regtest"]
```

docker-compose.yaml のサービスはこんな感じか。
こちらはまあまあ自分で作った。ような気がする。

```yaml
services:
  bitcoind:
    build:
      context: .
      dockerfile: ./Dockerfile
    container_name: bitcoin-regtest
    ports:
      - "18443:18443"
    command: >
      bitcoind
      -regtest=1
      -server=1
      -printtoconsole
      -rpcallowip=0.0.0.0/0
      -rpcbind=0.0.0.0
      -rpcuser=testuser
      -rpcpassword=testpassword
      -fallbackfee=0.000001
```

これにアクセスする `bticoin-cli` はこんな感じ。  
最初は `docker exec` ではなく `docker run` にしていて、つながらないつながらないと長いこと悩んでいた。

```bash
docker exec -it bitcoin-regtest bitcoin-cli -regtest -rpcuser=testuser -rpcpassword=testpassword $@
```
