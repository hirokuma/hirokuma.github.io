---
layout: post
title: "rust: cargo clippy は Option.mapを使えという"
tags:
  - rust
date: "2025/12/08"
---

値があれば更新するけど存在しない場合があるので `Option<i32>` と書いていた。  
引数をもらってきて、こんな感じで書いていた。

```rust
let value = if let Some(v) = value {
  Some(value * 2)
} else {
  None
};
```

`cargo clippy -- -D dead_code` を実行したところ、"manual implementation of `Option::map" と言われて修正方法まで提案された。  
こんな感じになるのかな。

```rust
let value = value.map(|value| value * 2);
```

えー、わかるんやけんいいやん、と思って Gemini氏に抗議?したところ、これは慣例的なRustコード(Idiomatic Rust)というものですよと諭された。  
それなら仕方ないか。

## おまけ

`cargo clippy` でよく出てきたやつ

* 仮引数の `: &String` は `: &str` でよいよ
  * `.clone()` しているなら `.to_owned()` にする
* 参照した引数を別の関数に渡すときに `&` 付きで渡している
* `.clone()` してるけど deref (`*`) でよいよ
* `&Vec<String>` は `&[String]` でよいよ
* `.len()` と `0` を比較するなら `.is_empty()` を使うとよいよ
* `match` で片方は何もせず `{}` だけ書いているなら `if let` でよいよ
  * それが `let Some(_)` なら `.is_some()` を使うとよいよ
* 名前が `to_` で始まるやつはそれなりの実装にしてね
