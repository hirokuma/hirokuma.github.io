---
layout: post
title: "rust: tracingログあれこれ"
tags:
  - 
date: "2025/12/16"
---

## 基本形

ログマクロは `log::*` だが `tracing_subscriber` を使う。  
これを基本形としてあれこれやっていこう。

```rust
use log::*;
// use tracing;
use tracing_subscriber;

struct Sub{}

impl Sub {
    pub fn subsub(value: u32) -> u32 {
        info!("subsub: {value}");
        value
    }
}

fn sub(value: u32) -> u32 {
    info!("sub: {value}");
    Sub::subsub(value)
}

fn main() {
    tracing_subscriber::fmt::init();

    info!("main");
    let value = sub(10);
    info!("main done: {value}");
}
```

実行。  
ここも含めて `RUST_LOG=info cargo run` を実行する。  
"hello" はこのプロジェクト全体の名前である(`cargo new hello` で作った)。

```log
2025-12-16T14:17:27.800254Z  INFO hello: main
2025-12-16T14:17:27.800292Z  INFO hello: sub: 10
2025-12-16T14:17:27.800299Z  INFO hello: subsub: 10
2025-12-16T14:17:27.800302Z  INFO hello: main done: 10
```

## tracing::instrument

`sub()` にだけ `tracing::instrument` をつける。  
そうすると `subsub()` にも引き継がれはしないが、"span" として "sub{value=10}" が設定されたので `subsub()` のログにもそれが出力されたと思われる。  

```rust
#[tracing::instrument]
fn sub(value: u32) -> u32 {
    info!("sub: {value}");
    Sub::subsub(value)
}
```

実行

```log
2025-12-16T14:20:22.701777Z  INFO hello: main
2025-12-16T14:20:22.701865Z  INFO sub{value=10}: hello: sub: 10
2025-12-16T14:20:22.701893Z  INFO sub{value=10}: hello: subsub: 10
2025-12-16T14:20:22.701924Z  INFO hello: main done: 10
```

### skip_all

`skip_all` をつける。

```rust
#[tracing::instrument(skip_all)]
```

実行

```log
2025-12-16T14:22:40.621335Z  INFO hello: main
2025-12-16T14:22:40.621419Z  INFO sub: hello: sub: 10
2025-12-16T14:22:40.621446Z  INFO sub: hello: subsub: 10
2025-12-16T14:22:40.621475Z  INFO hello: main done: 10
```
### ACTIVE

`instrument` で関数の入と出を出力するため `ACTIVE` を設定。  
(先程の skip_all は消した)

```rust
use tracing_subscriber::{self, fmt::format::FmtSpan};

...

fn main() {
    tracing_subscriber::fmt::Subscriber::builder()
        .with_span_events(FmtSpan::ACTIVE)
        .init();
...
```

実行

```log
2025-12-16T14:30:08.653089Z  INFO hello: main
2025-12-16T14:30:08.653160Z  INFO sub{value=10}: hello: enter
2025-12-16T14:30:08.653176Z  INFO sub{value=10}: hello: sub: 10
2025-12-16T14:30:08.653184Z  INFO sub{value=10}: hello: subsub: 10
2025-12-16T14:30:08.653189Z  INFO sub{value=10}: hello: exit
2025-12-16T14:30:08.653199Z  INFO hello: main done: 10
```

### subsub() にも instrument

`subsub()` にも `instrument` を設定する。  
span が "sub{value=10}:subsub{value=10}" と長くなった。

```rust
use log::*;
// use tracing;
use tracing_subscriber::{self, fmt::format::FmtSpan};

struct Sub {}

impl Sub {
    #[tracing::instrument]
    pub fn subsub(value: u32) -> u32 {
        info!("subsub: {value}");
        value
    }
}

#[tracing::instrument]
fn sub(value: u32) -> u32 {
    info!("sub: {value}");
    Sub::subsub(value)
}

fn main() {
    tracing_subscriber::fmt::Subscriber::builder()
        .with_span_events(FmtSpan::ACTIVE)
        .init();

    info!("main");
    let value = sub(10);
    info!("main done: {value}");
}
```

実行

```log
2025-12-16T14:39:16.767685Z  INFO hello: main
2025-12-16T14:39:16.767770Z  INFO sub{value=10}: hello: enter
2025-12-16T14:39:16.767794Z  INFO sub{value=10}: hello: sub: 10
2025-12-16T14:39:16.767827Z  INFO sub{value=10}:subsub{value=10}: hello: enter
2025-12-16T14:39:16.767849Z  INFO sub{value=10}:subsub{value=10}: hello: subsub: 10
2025-12-16T14:39:16.767875Z  INFO sub{value=10}:subsub{value=10}: hello: exit
2025-12-16T14:39:16.767904Z  INFO sub{value=10}: hello: exit
2025-12-16T14:39:16.767927Z  INFO hello: main done: 10
```

文字だと分かりづらいが、エスケープシーケンスで色がついているのでプロジェクト名と span はコンソールだとわかりやすいか。

![image](images/20251216a-1.png)

### json

ログを出力するときはテキストファイルに吐き出させたいことも多い。  
1行ごとの JSON になっているログもよく見る。

features に "json" を加えると `.json()` が使えるようになる。

```toml
tracing-subscriber = { version = "0.3", features = ["env-filter", "json"] }
```

```rust
fn main() {
    tracing_subscriber::fmt::Subscriber::builder()
        .json()
        .init();
...
```

実行

```json
{"timestamp":"2025-12-16T14:47:27.435203Z","level":"INFO","fields":{"message":"main","log.target":"hello","log.module_path":"hello","log.file":"src/main.rs","log.line":37},"target":"hello"}
{"timestamp":"2025-12-16T14:47:27.435300Z","level":"INFO","fields":{"message":"sub: 10","log.target":"hello","log.module_path":"hello","log.file":"src/main.rs","log.line":18},"target":"hello","span":{"value":10,"name":"sub"},"spans":[{"value":10,"name":"sub"}]}
{"timestamp":"2025-12-16T14:47:27.435355Z","level":"INFO","fields":{"message":"subsub: 10","log.target":"hello","log.module_path":"hello","log.file":"src/main.rs","log.line":11},"target":"hello","span":{"value":10,"name":"subsub"},"spans":[{"value":10,"name":"sub"},{"value":10,"name":"subsub"}]}
{"timestamp":"2025-12-16T14:47:27.435396Z","level":"INFO","fields":{"message":"main done: 10","log.target":"hello","log.module_path":"hello","log.file":"src/main.rs","log.line":39},"target":"hello"}
```

プロジェクト名が何度も出力されているが、モジュールが別になるとありがたみが出てくるのだろうか。
