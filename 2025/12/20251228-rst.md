---
layout: post
title: "rust: 読み方が分からないメソッド (1)"
tags:
  - rust
date: "2025/12/28"
---

関数でもメソッドでも良いのだが、ドキュメントがあっても使い方が分からないものがしばしばある。  
AI のおかげでなんとかなっている(たぶん)のだが、聞かずに済むならそれに越したことはない。

そういうのに突き当たったときにメモを残しておこう。

## redb::ReadableTable::range()

ちょっとした DB を使いたくて調べたときに [redb](https://www.redb.org/) が出てきた。  
SQL が使いたいほどでも無いので key-value のを探していたのだ。

1つのテーブルに対して value にした構造体の一部が条件に一致したものだけ値を変更したい。  
条件に一致したものを取得だけするだけならこういう感じ。

* `db.begin_read()` で `txn: ReadableTransaction` を得る
* `txn.open_table()` で `table: ReadOnlyTable` を得る
* `table.iter()?.filter_map()` などでグルグル回す

redb には更新用の関数は無く、[insert()](https://docs.rs/redb/latest/redb/struct.Table.html#method.insert) で同じ key を指定することで置き換えられる。  
更新する前提であれば、単に `v = get(k)` して `table.insert(k, v)` するよりも `gv = mut_get(k)` して `gv.insert(v)` とする方が効率が良い可能性が高い。  
というところに至るまで大変だったので省略だ。deepwiki の質問履歴を載せておく。  
サンプルコードが出てきても動くとは限らないのだ。

* [deepwiki](https://deepwiki.com/search/txn-writetransactiontableopent_4cbf9f87-1a8f-4b55-9e72-bcf1ca642330?mode=fast)

その途中で出てきたのが `.range()` だ。  
サンプルコードが `table.iter()?` から `table.range(..)?` になった。  
イテレータを使うと `table` が borrow になってしまって `table.insert()` できなくなるのだ。

* [ReadableTable in redb - Rust https://docs.rs/redb/latest/redb/trait.ReadableTable.html#tymethod.range]

`ReadableTable` は `struct` ではなくトレイト定義だ。  
`trait ReadableTable<K: Key + 'static, V: Value + 'static>: ReadableTableMetadata` だけで絶望しそうになる。

```rust
fn range<'a, KR>(
    &self,
    range: impl RangeBounds<KR> + 'a,
) -> Result<Range<'_, K, V>>
where
    KR: Borrow<K::SelfType<'a>> + 'a,
```

正直なところ、これを見た瞬間に考えるのをやめてしまった。  
習熟するとわかるようになるものなのだろうか？

ChatGPT としては「初学者なら分からんでも大丈夫」らしい。  
`range` 慣れしたら「これはあれね」ってわかるようになるのかもしれない。

* [ChatGPT](https://chatgpt.com/share/695092a0-3284-8010-bdf9-4deaf5e15732)

`where` はトレイト境界で、`KR` は `Borrow<K::SelfType<'a>> + 'a` というトレイトですよ、という意味か。
`+ 'a` なのは変数にライフタイムを付けるのではなく、型にライフタイムを付けるため。  


`range<'a, KR>` は、ライフタイム `'a` で、ジェネリックな型として `KR` を使っていますよ？  
で引数の `range` は `impl RangeBounds<KR> + 'a` でさらにトレイト境界？？  
もう何が何やら・・・。

最初のサンプルコード通りに使えたのならたぶん調べなかったのだが "type annotation needed" になったのだ。  
`(..)` では型の推測に使えるものがないからだろう。  
では、何のための型を書けば良いのかわからなかったのでドキュメントを見たけどさらにわからなくなった、という次第である。

型は key に対しての型を書けば良いということだった。
`KR` は "Key Range" の略ということかね。  

ともかく、安易に `range` という名前の変数や関数を作らない方がよいことはわかった。
`to_xxx()` や `from_xxx()` のように慣例には従う方がお互いに良いのだ。

### ChatGPT に redb の更新を聞くとぐだぐだ

deepwiki での回答を元に ChatGPT にも聞いてみたが、なんだかぐだぐだだった。

* [ChatGPT](https://chatgpt.com/share/6950a064-ee7c-8010-b603-4a7e3d56d569)

> value_mut() という関数はどこから考えついたのか？ 想像か？
>> その通り。私の想像による誤りだ。

力強いね。
