---
layout: post
title: "rust: ureqでHTTPエラーとbodyを取得"
tags:
  - rust
date: "2025/11/22"
---

JSON-RPC というか REST というかで通信しようとしている。

* [rust: tiny-http は非同期呼び出しできない - hiro99ma blog](https://blog.hirokuma.work/2025/11/20251118-rst.html)

結局 [tokio-rs/axum](https://github.com/tokio-rs/axum) を使うことにした。  
クライアントの方は [algesten/ureq](https://github.com/algesten/ureq) を使う。

axum 側は [anyhow-response-error](https://github.com/tokio-rs/axum/blob/b1ef45469bf8ffa334e86ddd12e7f4d4b82fa1ab/examples/anyhow-error-response/src/main.rs) や
[custom-extractor-error](https://github.com/tokio-rs/axum/blob/b1ef45469bf8ffa334e86ddd12e7f4d4b82fa1ab/examples/customize-extractor-error/src/derive_from_request.rs) を参考に
タプルの形でステータスコードと JSON を返すようにした。

ureq の方を [error-handling](https://github.com/algesten/ureq?tab=readme-ov-file#error-handling) で処理してみると、
ステータスコードは取れるのだが JSON の方が取って来れない。

どうやってもうまく行かなかったので、もう deepwiki にお頼みした。

* [エラーでStatus CodeとBodyを取得する](https://deepwiki.com/search/status-codebody_2c5a5bb2-4117-4739-aa3d-97d0ce415f78?mode=fast)

ポイントは `ureq::post()` などで直接やるのではなく `ureq::Agent` を使い、
`.http_status_as_error(false)` でエラーがあっても継続する？ようにするそうだ。

* [hirokuma/localrest-example at e6fa353b54df7cad48f4844ccf6079bbf1ada67f](https://github.com/hirokuma/localrest-example/tree/e6fa353b54df7cad48f4844ccf6079bbf1ada67f)

```shell
$ ./target/debug/cli error
status code: 500 Internal Server Error
{
  "from": "anyhow error happen",
  "message": "not success"
}
```
