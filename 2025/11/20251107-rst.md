---
layout: post
title: "rust: 非同期とtokio"
tags:
  - rust
date: "2025/11/09"
draft: true
---

「ジュリ～！」、というわけで今回は Rust の非同期関連だ。  
TOKIO といえば沢田研二氏だと思う。

使っているライブラリに `async` と `.await`、あと `#[tokio::main]` が出てきたので調べておく。

## async / await は昔は無かった

昔購入した Rust の本があるのだが、それにはキーワードも含めて `async` と `await` が載っていなかった。
おそらく [The Rust Programming Language 日本語版](https://doc.rust-jp.rs/book-ja/#the-rust-programming-language-%E6%97%A5%E6%9C%AC%E8%AA%9E%E7%89%88) を冊子にしたものなので、
途中から追加されたキーワードなのだろう。  
[原本](https://doc.rust-lang.org/book/)には [Fundamentals of Asynchronous Programming: Async, Await, Futures, and Streams](https://doc.rust-lang.org/book/ch17-00-async-await.html#fundamentals-of-asynchronous-programming-async-await-futures-and-streams) の章があるので
そちらを読んだ方がよいか。

技術書の翻訳だと原文の方が意味が通じやすかったり、あとで検索するときのために英語での表現を知っていた方が助かったりすることもある。
しかし初学者(かつ英語苦手)にとっては、とりあえず AI に尋ねてみるか、本家筋に近い日本語の資料を手始めにしそうだ。  
自動翻訳は便利なのだが、文字だけだと例えば `Future` のような普通の英単語にもあるキーワードを「将来」と訳したり「フューチャー」とカタカナになっていたりすると読む人に迷いが生じてしまう。
原文も `Future` とキーワードっぽく書いてあったり、タイトルでは "Futures" と複数になっていたり、イタリック小文字で "futures" と書いてあったりでわざとそうしているのか私では判断できなかった。

ともかく原本の 17章を読むのがよさそうだ。
16章の「恐れるな！並行性(Fearless Concurrency)」も読まないといかんだろうなあ。
というより、全部目は通すべきなんだけど、途中で中断してしまった。

* 17 Fundamentals of Asynchronous Programming: Async, Await, Futures, and Streams
* 17.1 Futures and the Async Syntax
* 17.2 Applying Concurrency with Async
* 17.3 Working with Any Number of Futures
* 17.4 Streams: Futures in Sequence
* 17.5 A Closer Look at the Traits for Async
* 17.6 Futures, Tasks, and Threads

タイトルだけでも書いておいて、自分の読む気を高めよう。

## async / await

「The Rust Programming Language 日本語版」にキーワードとしては載っていたので抜粋。

* `async` - 現在のスレッドをブロックする代わりにFutureを返す
* `await` - Futureの結果が準備できるまで実行を停止する

ライブラリを使った範囲では感覚的にこんなものだと思っている。

* `async fn` の関数は非同期関数になる。  
* `async fn` を呼び出した関数もまた `async fn` になるのだが、これは `block_on()` などとして同期にすることができる。  
* `.await` は `async fn` 関数の呼び出しに付ける。付けないと `Future` を返す。
* `.await` を付けるとその関数は同期呼び出しになるが、呼び出した関数は `async fn` になる。
* `main()` は `#[tokio::main]` を付けると非同期にできる
* `async` と `await` は言語仕様だが tokio はエンジン的なもので他にも種類はある
* `Future` は JavaScript の `Promise` みたいなものか？  

(WIP...)

