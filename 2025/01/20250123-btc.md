# btc: bitcoinjs-lib ã‚’ä½¿ã† (2)

_2025/01/23_

## ã¯ã˜ã‚ã«

P2TR ã‚’æ‰±ã†ã®ã« node.js ã§ä½¿ãˆã‚‹ bitcoinjs-lib ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†ã€‚

* [bitcoinjs/bitcoinjs-lib: A javascript Bitcoin library for node.js and browsers.](https://github.com/bitcoinjs/bitcoinjs-lib)

## TypeScript ç’°å¢ƒ

ã¡ã‚‡ã‚ã£ã¨æ›¸ãã«ã¯ JavaScript ã®æ–¹ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œãªãã¦æ¥½ãªã®ã ãŒã€
ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§å¤‰æ•°åã‚’é–“é•ãˆãŸã‚Šã™ã‚‹ã¨é¢å€’ãªã®ã§ TypeScript ã«ã—ã¦ãŠã“ã†ã€‚

`ts-node` ã ã¨æ¥½ã¯ã§ãã‚‹ã®ã ãŒã€ä»Šå›ã¯ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã—ã¦ã‹ã‚‰å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠã“ã†ã€‚

* [ts-node ã¯ä½•è€…ãªã®ã‹ - hiro99ma blog](https://blog.hirokuma.work/2024/12/20241226-tsc.html)

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚’ `js-keypath` ã«ã—ã¦ã€ã¾ãšã¯ key path ã®å‹•ä½œã‚’ç¢ºèªã™ã‚‹ã€‚

```console
$ mkdir js-keypath
$ cd js-keypath
$ npm init -y
$ npm i typescript @types/node
$ npx tsc --init
$ echo -e "node_modules/\ndist/" > .gitignore
$ git commit -a -m "first commit"
```

ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯åˆ¥ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å‡ºåŠ›ã—ãŸã„ã®ã§ tsconfig.json ã‚’ã¡ã‚‡ã£ã¨ã ã‘å¤‰æ›´ã€‚

```json
  "outDir": "./dist",
```

package.json ã‚‚ã¡ã‚‡ã£ã¨å¤‰ãˆã¦ãŠã“ã†ã€‚  
ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã¨å®Ÿè¡Œã‚’åŒæ™‚ã«ã‚„ã‚‹ãªã‚‰ `ts-node` ã§ã„ã„ã‚„ã‚“ã£ã¦ãªã‚‹ã‘ã©ã€ã„ã„ã‚“ã ã‚ˆã€‚

```json
  "scripts": {
    "start": "npx tsc; node dist/index.js"
  },
```

å‹•ä½œç¢ºèªã®ãŸã‚ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `index.ts` ã‚’ä½œã‚‹ã€‚

```ts
console.log('hello, world');
```

å®Ÿè¡Œã€‚

```console
$ npm start

> js-keypath@1.0.0 start
> npx tsc; node dist/index.js

hello, world
```

## bitcoinjs-lib ç’°å¢ƒ

ã“ã‚Œã‚’æ›¸ã„ã¦ã„ã‚‹æ™‚ç‚¹ã§ã¯ bitcoinjs-lib v6.1.7 ãŒ rc ç„¡ã—ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã®ã§ãã‚Œã‚’ä½¿ã£ã¦ãŠã“ã†ã€‚

```console
$ npm i bitcoinjs-lib@v6.1.7 ecpair
```

## bitcoind regtest ç’°å¢ƒ

regtest ã‚’ç«‹ã¦ã¦ãŠãã€‚  
P2TR ã«å¯¾å¿œã—ã¦ã„ã‚Œã°ç‰¹ã« bitcoind ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯å•ã‚ãªã„ã€‚

* `~/.bitcoin/regtest.conf`

```file
server=1
regtest=1
rpcuser=user
rpcpassword=pass
fallbackfee=0.00001
```

regtest ã‚’ä¸€ã‹ã‚‰ã‚„ã‚Šç›´ã—ãŸã„å ´åˆã¯ `~/.bitcoin/regtest` ã‚’å‰Šé™¤ã™ã‚‹ã€‚  
ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã ã‘ã‚„ã‚Šç›´ã—ãŸã„å ´åˆã¯ `~/.bitcoin/regtest/wallet/test` ã‚’å‰Šé™¤ã™ã‚‹ã€‚

```console
$ rm -rf ~/.bitcoin/regtest/

$ bitcoind -regtest -daemon
Bitcoin Core starting

$ rm -rf ~/.bitcoin/regtest/wallets/
$ bitcoin-cli -regtest -named createwallet wallet_name=test load_on_startup=true
{
  "name": "test"
}
```

ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ "test" ã«ãŠé‡‘ã‚’å…¥ã‚Œã‚ˆã†ã€‚

```console
$ addr=`bitcoin-cli -regtest getnewaddress`

$ bitcoin-cli -regtest generatetoaddress 110 $addr
[
  ...
  ...
]

$ bitcoin-cli -regtest getbalance
500.00000000
```

ã‚‚ã¡ã‚ã‚“ã€ãƒ†ã‚¹ãƒˆç”¨ã® Bitcoin ãªã®ã§ãƒ†ã‚¹ãƒˆã§ã—ã‹ä½¿ãˆã¾ã›ã‚“(ä¸€å¿œæ›¸ã„ã¦ãŠã)ã€‚

## JSON-RPC ã‚¢ã‚¯ã‚»ã‚¹ã¨ `ERR_REQUIRE_ESM`

```console
$ npx tsc --version
Version 5.7.3
$ node --version
v18.20.5
```

æ˜”ä½œã£ã¦ã„ãŸ bitcoind ã¨ JSON-RPC ã™ã‚‹é–¢æ•°ãŒã‚ã£ãŸã®ã§æµç”¨ã™ã‚‹ã€‚  
`node-fetch` ã¨ã„ã†ã®ã‚’ä½¿ã£ã¦ã„ãŸã‚“ã ãªã‚ã€ã¨é©å½“ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã®ã ãŒ `ERR_REQUIRE_ESM` ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚

* [ts-nodeã¨node-fetchã®ç›¸æ€§ãŒæ‚ªã„](https://zenn.dev/tatsuyasusukida/articles/poor-compatibility-between-ts-node-and-node-fetch)

v2 ã«ã™ã‚‹ã¨ã‚ˆã„ãã†ã ã€‚  
ç¢ºã‹ã«å‰å›ã¯ãã‚“ãªã“ã¨ã‚’ã—ãŸæ°—ãŒã™ã‚‹ã€‚

node.js ã¯ `import` ã§ã¯ãªã `require()` ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã‘ã©ã€`node-fetch@v3` ã¯ `import` ã®ã¿ã ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸã¨ã„ã†ã“ã¨ã‹ã­ã€‚  
ESM ãŒãã®é•ã„ã ã‘ã‹ã©ã†ã‹ã¯çŸ¥ã‚‰ãªã„ã‘ã©ã€‚

`node_modules/` ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯è‡ªåˆ†ã§ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã®ã§ã¯ãªãã€JavaScript å½¢å¼ã«ãªã£ã¦ã„ã‚‹ã‚‚ã®ã—ã‹ãªã„ã®ã‹ãªï¼Ÿ 
ãã†ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã¯å‡ºãªã„ã ã‚ã†ã€‚  
node.js ã‚‚æ‹¡å¼µå­ãŒ `.mjs` ãªã‚‰ ESM å½¢å¼ã§å®Ÿè¡Œã™ã‚‹ãã†ã ãŒã€`npm` ã®ã—ãã¿ãŒãã†ã˜ã‚ƒãªã„ã¨ã„ã†ã‹ãƒ–ãƒ©ã‚¦ã‚¶ãŒãã†ã˜ã‚ƒãªã„ã¨ã„ã†ã“ã¨ã§ `.mjs` ã¨ã„ã†åå‰ã§ã¯ãªã„ã®ã ã‚ã†ã€‚  
ãã‚‚ãã‚‚ JavaScript ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ã‹ã™æ–¹ãŒä¸»ç›®çš„ã ã£ãŸã‹ã€‚  
ãªã‚‰ã° node.js å´ãŒä½•ã¨ã‹ã›ã­ã°ãªã‚‰ã¬ã€‚

è‡ªåˆ†ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ãªã„ã‹ã‚‰æ‹¡å¼µå­ã‚’å¤‰æ›´ã™ã‚‹ã¨ã„ã†æ‰‹æ®µã¯é¸ã¶ã“ã¨ãŒã§ããªã„ã€‚  
`package.json` ã« `"type": "module"` ã‚’å¤‰æ›´ã™ã‚‹ã¨ã‚ˆã„ãã†ã ã€‚  
ãŒã€TypeScript ã®ã‚³ãƒãƒ³ãƒ‰ `tsc` ãŒè‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã—ã¦ node.js ã§å‹•ã‹ã›ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã¯ã€CommonJS å½¢å¼ã§ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã‚ã‚‹ã€‚  
ãªã‚‰ã°ãã¡ã‚‰ã‚‚å¯¾å‡¦ãŒã„ã‚‹ã ã‚ã†ã€‚

* [Module - module](https://www.typescriptlang.org/tsconfig/#module)

`tsconfig.json` ã«ã“ã‚Œã® "ESNext" ä»¥é™ã‚’æŒ‡å®šã™ã‚Œã°ã©ã‚Œã§ã‚‚ `import` ã§ã„ã‘ã‚‹ã®ã‹ãªï¼Ÿ

> You very likely want "nodenext" for modern Node.js projects and preserve or esnext for code that will be bundled.

ã¨æ›¸ã„ã¦ã‚ã‚‹ã®ã§ preserve ã‚„ esnext è¾ºã‚ŠãŒç„¡é›£ã¨ã‹ï¼Ÿ 
preserve ã¯ TypeScript 5.4 ã‹ã‚‰è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã§ã„ã„ã®ã‹ãªã€‚

æŒ‡å®šã—ãŸã‚‰ã€ãªã‚“ã‹ã„ã‚ã„ã‚é¢å€’ã«ãªã£ãŸãƒ»ãƒ»ãƒ»ã€‚

* import ã—ãŸ TypeScript ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„
  * è‡ªåˆ†ã§ import ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã« `.js` ã‚’ä»˜ã‘ãªãã¦ã¯ãªã‚‰ãªã„ã‚‰ã—ã„(`.ts` ã§ã¯ãªã)
* import ã—ãŸ JSON ã§ã‚¨ãƒ©ãƒ¼
  * > TypeError [ERR_IMPORT_ASSERTION_TYPE_MISSING]: Module "file:///ã»ã«ã‚ƒã»ã«ã‚ƒ/config.json" needs an import attribute of type "json"
  * import ã®æœ€å¾Œã« `assert { type: 'json' }` ã¨ã‹æ›¸ã‹ãªã„ã¨ã„ã‹ã‚“ã‚‰ã—ã„([stackoverflow](https://stackoverflow.com/questions/70106880/err-import-assertion-type-missing-for-import-of-json-file))
    * ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«æ™‚ã«ã‚¨ãƒ©ãƒ¼ã«ã—ã¦ãã‚Œã‚Œã°ã„ã„ã®ã«ã€‚ã€‚
  * ãã®ä»£ã‚ã‚Šãªã®ã‹ `resolveJsonModule` ã¯ `true` ã«ã—ãªãã¦ã‚‚ä½¿ãˆã‚‹ï¼Ÿ

ä¸€å¿œå‹•ã„ãŸã€‚

* [commit](https://github.com/hirokuma/js-keypath/commit/3eee98d52d37bc6d8eb2236a04b91084d30ecdba)

`node-fetch` ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã‹ï¼Ÿ ã¨ã„ã†æ°—ãŒã—ã¦ã„ã‚‹ã€‚  
Node v18 ã‹ã‚‰ `fetch` ã‚’ã‚µãƒãƒ¼ãƒˆã—ãŸã¨ã‹(ã¾ã  experimental?)ã€Node ã«ã¯ãã‚‚ãã‚‚ "http" ãŒã‚ã‚‹ã¨ã‹ã€"http" ã¯ `await` ã§ä½¿ã†ã®ã¯é¢å€’ãã†ã¨ã‹ã€‚  
Twilio ã•ã‚“ã®ãƒ–ãƒ­ã‚°çµŒç”±ã§è¦‹ã¤ã‹ã£ãŸ ky ã¨ã„ã†ã®ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†ã€‚

* [Node.jsã§Aysnc/Awaitã‚’ä½¿ã£ã¦HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†5ã¤ã®æ–¹æ³• by Sam Agnew - Twilio](https://www.twilio.com/ja-jp/blog/5-ways-to-make-http-requests-in-node-js-using-async-await-jp)
  * [sindresorhus/got: ğŸŒ Human-friendly and powerful HTTP request library for Node.js](https://github.com/sindresorhus/got)
    * [sindresorhus/ky: ğŸŒ³ Tiny & elegant JavaScript HTTP client based on the Fetch API](https://github.com/sindresorhus/ky)

ã“ã¡ã‚‰ã‚‚å‹•ã„ãŸã€‚

* [commit](https://github.com/hirokuma/js-keypath/commit/acf084fe1e2a46fa718ba60e6392dbebc8fef19c)

ã“ã‚ŒãŒæ°—ã«å…¥ã£ãŸã€ã¨ã„ã†ã®ã¯æ€ã„ã¤ã‹ãªã„ãŒã€ç‰¹ã« `fetch` ã«æ…£ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã‚‚ãªã„ã®ã§ã©ã¡ã‚‰ã§ã‚‚ã‚ˆã„ã‹ãªã€‚

## ãŠã‚ã‚Šã«

æº–å‚™ã¯ã§ããŸã¨æ€ã†ã€‚
