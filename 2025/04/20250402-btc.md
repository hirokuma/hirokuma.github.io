# btc: bitcoindのblocksを別ディレクトリにしたい

_2025/04/02_

## はじめに

Raspberry Pi でフルノードを立てている。  
1TB の HDD が空いていたので遅くてもよいやと pruned にしていた。  
electrs を立ち上げてみたくなったのだが pruned ではダメだという。
まあ、そりゃそうだ。

pruned から元に戻すには最初から IBD のやり直しになる。  
既に 2週間くらいやり続けているのだが後10日くらいはかかりそうだ。  
フルノードが収まるほどの SSD は空いていないので購入まで考えていたのだが、
特にフルノードを立てて何かしたいという程でもないので、なんだかもったいない。

~~340~~ 240 GB の SSD は空いていたのでデータを分割できるなら使えるかも、と思った。

## 現状

txindex は指定していないので、これは以前のファイルが残っているだけだろう。  
compact filter は LND を立てていたこともあってセットしているのだが、
LND 以外で使われているのを見たことがないので外してもよいかと思っている。

```console
$ du -h
12G     ./chainstate
201M    ./blocks/index
685G    ./blocks
11G     ./indexes/blockfilter
31G     ./indexes/txindex
42G     ./indexes
738G    .
```

## 分割案

bitcoind の機能として、データをサイズごとにディレクトリに分けるようなものはない。  
ChatGPT氏に案を訊くと、シンボリックリンクにしたら？という提案をされた。
LVM も提案されたが、私はやったことないし、古いデータだけ HDD に残したいので
手動でやった方が良い気がしている。

ファイルは1万個近くあるが、シンボリックリンクはワイルドカードで作ることもできそうなのでそこまで負担にはならないだろう。

* [ワイルドカードでマッチした全ファイルに対するシンボリックリンクを作成する方法 - でぶぬる日記](https://aquarla.hatenadiary.org/entry/20121206/1354784935)

メインのディスクを ~~340~~ 240 GB の SSD にして、
今ある blocks はファイルをシンボリックリンクに、
chainstate と indexes はディレクトリをシンボリックリンクにし、
それ以外は SSD に移動させるとよさそうだ。

* [Data directory layout](https://github.com/bitcoin/bitcoin/blob/v28.1/doc/files.md#data-directory-layout)

bitcoind の起動時にデータをチェックされるので HDD にあるファイルが多いと時間はかかるのだが
それはもう仕方あるまい。
どのくらいかかるかは記憶にない。1日以上かかることはないと思いたい。

## やってみよう

やるにしても気力がいるので、そのとき追記しよう。  
構想はこんな感じ。ファイルの移動が一番少ないやり方だと思う。

![image](images/20250402a-1.png)

いま SSD を引っ張ってきて分かったが 240GB だった。  
危ないところだった。。。  
1ヶ月で +10 GB として 2年くらいか。

シンボリックリンクを作成すると 300 KB 未満で済んだ。  
`blocks/index/` は忘れていたのだが、これも本体は HDD に置いてシンボリックリンクにした。

Raspberry Pi に HDD と SSD の 2本差しができるか心配だったが、今のところ大丈夫そうだ。  
もう1つ CPU ファンの USB も Raspberry Pi から取っていたのだが HDD の音があやしかったので外付けにした。

systemctl で動かしているので start させた。  
かなり長い時間待たされて。。。プロンプトに戻った！  
`getblockchaininfo` で結果が返ってきた！

たぶん成功だ。
