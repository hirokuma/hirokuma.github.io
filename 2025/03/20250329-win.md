---
layout: post
title: "win: クリップボードに格納するとIME入力がおかしくなる(未解決→対処)"
tags:
  - windows
date: 2025/03/29
---

## はじめに(2025/03/30)

### 仮対策

* AutoHotKey のクリップボード監視を使い、変更されたときに ctfmon.exe プロセスを kill する

### 今のところ分かったこと

* クリップボードに格納後、IME が 30秒間使えなくなる
* ATOKだけでなくIME全般
* ctfmon.exe のプロセスを kill すると直っている(勝手に復帰する)

## 現象

最近、作業環境をノートPC(Win11 Home 23H2)からデスクトップPC(Win11 Pro 23H2)に戻ったのだが、typoが多くなった。
いろいろ試したところ、コピーなり切り取りなりでクリップボードに格納した後に日本語入力IMEがおかしくなることがわかった。

<video controls>
  <source src="images/20250329-winkey.mp4" type="video/mp4" />
</video>

これは ATOK と MS Word だが、他のアプリでは日本語入力ができないままになる。

非常にやっかいな現象だ。

そして・・・突然直ったりする。
これを書いている今がそれだ・・・。

書いているのは vscode なのだが動画を作ったばかりの MS Word でも起きなくなった。  
やったのは、動画を作ったので vscode を立ち上げて入力しているだけだ。

えー、これ昨日からずっと困ってたのに。  
ATOKの再インストールや、他の設定をいじったりして、元に戻せるかどうか分からないくらいまでなっている。

検索すると "テキストインプットサービス" や "ctfmon.exe" などがよく出てくるのだが、
ctfmon.exe を立ち上げるとその時は直るものの、また Ctrl+C などすると戻ってしまったのだ。

うーーーん・・・・。

## その後

PC を再起動したら発生した。ほらね。

一つ分かったのは、時間経過なのかわからないが急に直るということだ。  
キーを押しっぱなしにしているだけなのだが急に IME が復帰している。

<video controls>
  <source src="images/20250329a-2.mp4" type="video/mp4" />
</video>

時間を測ったが、ちょうど30秒だ。  
どれかのプロセスが再起動したとかだろうか。

また、この現象は IME が ON だろうが OFF だろうが関係なく発生している。
OFF の状態でコピーすると IME ON のキー(私は JISキーボードで「変換キー」に割り当てている)を押しても反応しない。  
MS-IME を前面に出していても現象は同じなので、おそらく ATOK が原因というわけではない。

クリップボードが原因のトリガーになっているので無効にしていたクリップボード履歴を使えるようにしたものの変わらず。  
有効にしたが変わらない。

イベントビューアで何か起きていないか探そうとしたが、これはやり方がよくわからなかった。  
現象を起こすことはできるので時間指定でイベントを探そうとしたのだが、やり方が悪かったのだろうか。

ファイアウォールを無効してみたが、関係なし。  
まあ、そうだろう。

ctfmon.exe 関係でネット検索するが、ほどよい情報がない。  
だいたい ".exe" で検索すると、ウイルスがどうこうと大半が自動で作ったような記事がヒットして困る。  
自動起動していないというのは当てはまらない。  
現象が起きてすぐに ctfmon.exe をタスクマネージャーで停止させると直る。
単にタスクマネージャーにウィンドウを切り替えただけだったり停止ダイアログを表示するだけだと直らないので、
そういった要素で直ったわけではないはずだ。  
ctfmon.exe 以外でも直るのかもしれないが、OfficeClickToRun.exe では(これも自動復帰する)直らなかったので、少なくとも何でもよいというわけでもなさそうだ。
TextInputHost.exe も似た雰囲気があるがダメだった。  
Common Text Framework、恐るべし。。。

ctfmon.exe が出てきたので少しやったが、regsvr しても効果は無かった。
まあ、立ち上がってるしね。

* [ctfmon.exe error every 22 seconds. How do I fix it? - Microsoft Community](https://answers.microsoft.com/en-us/windows/forum/all/ctfmonexe-error-every-22-seconds-how-do-i-fix-it/91a3926f-a77d-49bb-91dc-9740d146e2f9)

同一PC で別のadminアカウントがあるのだが、そちらでは起きなかった。  
なので共通で使っているファイルに原因があるわけではないだろう。  
昔悩んでいた PNG のプレビュー画像が表示されないときもそうだったが、
別アカウントを作ってください、は対処じゃないと思うのだよ。  
最近は AppData にインストールするものもあるし。
レジストリはマルチアカウントのためにやってたんじゃないのかと思うが、どうしようもなくなったのか。

## AutoHotKey

根本的な対策はあきらめた。

私の環境では AutoHotKey を立ち上げているのだが、
クリップボードに変化があったらコールバックを受け取ることができるので、
そのタイミングで ctfmon.exe プロセスを閉じてしまおう。

AutoHotKey v2 ではこんな感じ(v1は見てない)。

```ahk
OnClipboardChange ClipChanged

ClipChanged(DataType) {
    ProcessClose "ctfmon.exe"
}
```

コピーしてすぐ操作すると間に合わないかもしれないが、
心に余裕を持って操作すれば大丈夫だろう。

## 後日(2025/04/06)

ノートPC でも同じ AutoHotKey のスクリプトを使っていたのだが ctfmon.exe を kill するときにだと思うがエラーが出ることがあった。  
それに入力している途中に作動することがあるのか未確定の文字が確定されたりした。

さすがにうっとうしいので一時的に AutoHotKey のクリップボード監視を止めてみた。  
ノートPC はそれでよいのだがデスクトップPC でまた問題が起きるだろう。  
と思って確認したのだが、この現象が今日は起きない。。。

あんだけ再起動しても発生していたのだが、何だろう？  
Windows Update の 2025年3月分を反映したことでちょうど解消されたのだろうか？

分からぬ。。。

## その後(2025/04/07)

その翌日、また現象が発生した。  
仕方ないのでデスクトップ PC 用とノート PC 用で AutoHotKey のスクリプトを分けることにした。
