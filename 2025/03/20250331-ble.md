# ble: gattlib

_2025/03/31_

## はじめに

最近コーディングというか、製品のコーディングをしていない。  
特に作りたいものもないので、ここ1年くらいで調べた範囲で作ることにした。

Raspberry Pi があるので、それに BLE central をやってもらおう。  
この時点で調べた範囲に入っていないのだが、まあよい。

## gattlib

Bluez を使ってみようと思ったのだが、使うのが難しそうだった。  
ラッパーのようになっていて BLE 用の gattlib というものがあったので少し動かした。

* [https://github.com/labapart/gattlib](https://github.com/labapart/gattlib)

```console
sudo apt install libbluetooth-dev libreadline-dev libglib2.0-dev libpcre3-dev
git clone https://github.com/labapart/gattlib.git
cd gattlib
git checkout -b v0.7.2 refs/tags/0.7.2
mkdir build && cd build
cmake ..
make
```

これでサンプルアプリまでビルドされる。

### ble_scan はちょっと危険？

`ble_scan` を動かしてみた。`sudo` なしで動作している。

```console
$ ./examples/ble_scan/ble_scan
Discovered xx:xx:xx:xx:xx:xx - 'Zephyr Heartrate Sensor'
Scan completed
------------START xx:xx:xx:xx:xx:xx ---------------
------------DONE xx:xx:xx:xx:xx:xx ---------------
```

名前が "scan" なのだが connect もするようだ。  
DONE と出力されるのだが Advertising が止まったままなので disconnect しない・・・？  
Ctrl+C で終了させてもそのままなので、明示的に切断させないと kernel 側かどこかが維持してしまうようだ。

これ、自動的にスキャンして接続してしかも維持するので、
マンションみたいな集合住宅だと気付かずに見知らぬ人の BLE 機器に接続したままにしてしまいそうだ。

## Bluetooth の一時停止

`rfkill` で無線関係の機器をブロックできるそうだ。

```console
$ rfkill
ID TYPE      DEVICE      SOFT      HARD
 0 bluetooth hci0   unblocked unblocked
 1 wlan      phy0   unblocked unblocked
$ rfkill block 0
$ rfkill
ID TYPE      DEVICE      SOFT      HARD
 0 bluetooth hci0     blocked unblocked
 1 wlan      phy0   unblocked unblocked
```

この状態で `ble_scan` するとエラーになるので止まってるだろう。

```console
 $ ./examples/ble_scan/ble_scan

** (process:215757): WARNING **: 09:27:09.093: Error setting property 'Powered' on interface org.bluez.Adapter1: GDBus.Error:org.bluez.Error.Failed: Failed (g-io-error-quark, 36)
gattlib_ble_scan: Failed to set discovery filter: GDBus.Error:org.bluez.Error.NotReady: Resource Not Ready (196.36)
gattlib_ble_scan: Failed to scan.
```

が！  
これでも Advertising が始まっていなかった。  
接続されたままなのか、peripheral が何かしているのか判断できない。  
けれども、Android の nRF Connect で connect / disconnect したときは Advertising が始まっているからなあ。  
あー、でも時間が経つと Advertising が自動で止まっている感じもするので断言できない。

Raspberry Pi の再起動をせずに Bluetooth 機能を止めたいだけなので、
一番根っこに近いと思われる systemctl で再起動させた。

```console
$ sudo systemctl restart bluetooth
```

これで大丈夫な気はするのだが、確実にやるなら USBドングルにして引っこ抜けるようにするべきか。


