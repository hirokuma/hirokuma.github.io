---
layout: post
title: "rust: rust-bitcoin と BDK (3)"
tags:
  - rust
  - bitcoin
date: "2025/09/18"
---

前回の続き。

* [Introduction - Rust Bitcoin Cookbook](https://rust-bitcoin.org/book/intro.html)

## SegWit V1

昨日は SegWit V0 の P2WPKH だった。今日は SegWit V1 の P2TR(key path)である。

* [Taproot - Rust Bitcoin Cookbook](https://rust-bitcoin.org/book/tx_taproot.html)

コードはほとんど同じになるかと思ったのだが、そうでもなかった。  
V0 の書き方を変更すればあわせられそうな感じはする。
P2TR がどうなるかわからないときに実装されてちょっと思ってのと違うようになったとか？  
想像しても仕方ない。

* `senders_keys()`
  * keypair を返すようになった。V0 でも witness stack で pubkey がいるのだからそうしておけばよかったと思う。
* `receivers_address()`
  * `Address::from_str()` から `"アドレス".parse::<Address<_>>()` になった。
  * Bech32 と書いてあるけど P2TR だから Bech32m だよね？
  * `Address::from_str()` でもできたのでお好みで？
  * [struct Address](https://docs.rs/bitcoin/0.32.0/bitcoin/struct.Address.html#relevant-bips) に BIP350 が載っているのでさすがに Bech32m はダメということはないと思う。
* `dummy_unspent_transaction_output()`
  * [Verification trait](https://docs.rs/bitcoin/0.32.0/bitcoin/key/trait.Verification.html) は secp256k1 の方だ
  * `internal_key` を引数に取っているが、これは pubkey の方なんだな。確かに BIP341 も "internal key" は pubkey なのだけど `internal_pubkey` でもあるのだ。BIP の方が紛らわしくしているな。
  * 署名できる prevouts を作りたいというだけなので深く考えなくて良いだろう
* `main()`
  * さすがにいろいろ違う。
  * タプルで値を返すことができると便利だな。。C言語だと引数に全部展開するか構造体作るかのどちらかでちょっとわずらわしい。
  * [taproot_key_spend_signature_hash()](https://docs.rs/bitcoin/0.32.0/bitcoin/sighash/struct.SighashCache.html#method.taproot_key_spend_signature_hash) は [p2wpkh_signature_hash()](https://docs.rs/bitcoin/0.32.0/bitcoin/sighash/struct.SighashCache.html#method.p2wpkh_signature_hash) と違って prevouts を引数に取る。
    * [Prevouts::All](https://docs.rs/bitcoin/0.32.0/bitcoin/sighash/enum.Prevouts.html#variant.All) は Variants だそうだが、Variants ってなんだっけ？
      * enum らしい([ChatGPT](https://chatgpt.com/share/68cbda20-bc68-8010-ad5e-0bca68485b6d))。`SIGHASH_ALL` 的な、input は全部対象にするという All のようだ。
  * sighash と sig を求めるのに 10行程度で済むのか。。。

ライブラリががんばっているというのもあるだろうが、ステップ数が少ないというだけでずいぶんと楽だと感じた。  
まあ、一から書けといわれたら書けないけど、それは他の言語でも同じだからよいのだ。
