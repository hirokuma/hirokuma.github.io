---
layout: post
title: "btc: TRUCポリシー"
tags:
  - bitcoin
date: "2026/01/04"
---

2026年1月3日に Bitcoin Core v30.1 がリリースされていた。  
しばらく前までは v0.2x.y のようなバージョン名だったが、いつしか最初の "0." が取り除かれるようになった。

* [v30.1 Release Notes](https://github.com/bitcoin/bitcoin/blob/master/doc/release-notes/release-notes-30.1.md)

一番上に「don't consider unconfirmed TRUC coins with ancestors」とあるが、TRUC が何かわからなかった。
あまり自信はないが調べたことを書いてみよう。

## 多数決の世界

Bitcoin にはいろいろルールがあるが、誰もが守らないといけないルールと、ノードアプリで好きにできるルールがある。
好きにできるというか BIP で決まっていないので自由度があるというか、そういう感じ。  
Bitcoin Core がノード全体のかなりの比率を占めるので Bitcoin Core の実装がルールと思いがちだが、
設定ファイルなどで変更できるパラメータもあるし、ハードコーディングされている部分やデフォルト値が気に入らなければ
ソースコードを変更して運用している人々もいる。  
極端なことを言えば、自分でマイニングできてそれがコンセンサスルールに従っていると、そのマイナーがマイニングする分については誰も文句を言えない。
文句を言う＝コンセンサスルールが異なるので受け入れない、というところか。
ここで「俺はあのマイナーが気に入らないので無視してやる！」ということはできるが、それが多数派にならない限り意味がない。
民主主義というか多数決なのだ。

## TRUCポリシー

TRUC は Bitcoin Core のローカルルールの 1つらしい。  
mempool に関してはローカルルールというかポリシーの度合いが大きいようで、Bitcoin Core のポリシー変更はしばしば議論になる。

* [ChatGPT](https://chatgpt.com/share/69592f21-9864-8010-8c36-18dddb86f908)
* [Gemini](https://gemini.google.com/share/2a2d15183878)

Topologically Restricted Until Confirmation を略して TRUC と呼ぶそうだ。
Confirm するまでのトポロジー的な制約、とでも訳すのかな？  
ここでトポロジーはおそらく「接続形態」という意味で使われているのだろう。
トランザクションが Confirmするまで、つまり UTXO の状態にあるときにその親(input)と子(output)がどうあるべきか、というところだと思う。

* [wallet: don't consider unconfirmed TRUC coins with ancestors by glozow · Pull Request #33528 · bitcoin/bitcoin](https://github.com/bitcoin/bitcoin/pull/33528/files)
* [bips/bip-0431.mediawiki at master · bitcoin/bips](https://github.com/bitcoin/bips/blob/master/bip-0431.mediawiki)
* [Version 3 transaction relay - Bitcoin Optech](https://bitcoinops.org/en/topics/version-3-transaction-relay/)
* [Mempool Replacements](https://github.com/bitcoin/bitcoin/blob/ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb/doc/policy/mempool-replacements.md)

version 3 という言葉が出てくるが、これはトランザクションの先頭にある `nVersion` を `3` のことで、そうすると「このトランザクションはTRUCポリシーですよ」と主張することになる。
ChatGPT が最初は関係ないと言っていたので納得してしまいそうになったが BIP-431 や Gemini に質問することで回避できた。
危ないところだった。。。

内容は、Pinning Attack への対応への更新らしい。  
先祖が 2つ以上なら `continue` という実装になっているので、「1 input / 1 output」の「1 input」に対応したのだと思われる。  
[nVersion == 3](https://github.com/bitcoin/bitcoin/blob/ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb/src/wallet/spend.cpp#L402-L410) のときだけで、
その上の行に `nDepth == 0` などもあるから Unconfirmed だけという意味になるのかな。  
`coinControl` と `wtx.tx` の違いを調べていないので予想はここまででやめておこう。

### Pinning Attack

TRUC ポリシーは Pinning Attack に対応するためのものである。
私が読んだことのある Pinning Attack はこれだ。

* [https://x.com/Bitcoin_Devs/status/1903881770204070155](https://x.com/Bitcoin_Devs/status/1903881770204070155)

親子のトランザクションサイズ合計が 101KB までというポリシーを悪用する。  
Alice, Bob, Carol の 3人が登場する。被害者は Bobである。

まず、Alice は Bob と Carol へ支払うトランザクションを展開する。
このとき、手数料はかなり低めにしておく。

次に Carl は自身への支払い UTXO を使って 101KB にならないくらいのぎりぎりサイズになるトランザクションを作る。
これも手数料を相場よりかなり低めにして展開する。

Alice が展開したトランザクションも Carol が展開したトランザクションも手数料が低いのでマイナーからスルーされる。

さて、Bob がこの UTXO を使って支払いをしたくなったとしよう。  
Alice の展開した手数料が低くて承認されないので「まったくこいつは...」とぶつぶつ文句を言いながら Bob は CPFP になってもいいやとあきらめて手数料高めのトランザクションを展開しようとする。  
が、そのトランザクションは Bitcoin Core に拒絶される。
なぜなら、Alice + Carol のトランザクションサイズが合計すると 101KB 寸前で Bob のトランザクションを足すと超えてしまってポリシー違反になるからだ。  
Bob が Alice に何とかするよう文句を言っても「もう払ったしぃ」と言い逃れされ、Carol は知らない人なので連絡もできないし(たぶん Alice 本人だろうけど)で、
手数料の相場が下がるまで待つしかなくなる。

そういう、地味ながらもやっかいな攻撃である。  
じゃあ 101KB の制限をなくすとよいかというと、それはそれで DoS 攻撃や計算コストがかかりすぎたりするなど別の面が出てくる。
