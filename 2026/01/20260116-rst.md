---
layout: post
title: "rust: option_filter"
tags:
  - rust
date: "2026/01/16"
---

Rustで、コマンドラインオプションの最後があってもなくてもよいようにするため `Option<String>` にしていた。
`None` なら `None` のままでよいし、もし `Some` でも空文字列だったら `None` 扱いでよい。

```rust
  let opt = match opt {
      Some(v) => {
          if v.is_empty() {
              None
          } else {
              Some(v)
          }
      },
      None => None,
  };
```

これしかないと思っていたが `cargo clippy` がまだまだ甘いと告げてきた。

```rust
let opt = opt.filter(|v| !v.is_empty());
````

vscode は `filter` でジャンプした。
`feature = "option_filter"` とある。短いので載せてみたが、見てもわからん。。

```rust
    #[inline]
    #[stable(feature = "option_filter", since = "1.27.0")]
    #[rustc_const_unstable(feature = "const_option_ops", issue = "143956")]
    pub const fn filter<P>(self, predicate: P) -> Self
    where
        P: [const] FnOnce(&T) -> bool + [const] Destruct,
        T: [const] Destruct,
    {
        if let Some(x) = self {
            if predicate(&x) {
                return Some(x);
            }
        }
        None
    }
```

* [option_filter - Rust](https://docs.rs/option-filter/latest/option_filter/)

`filter()` の中にある判定が `true` であれば `Some` の値そのまま、そうでなかったら `None` を返す、だろう。  
この書き方はなかなか思いつかないね。
