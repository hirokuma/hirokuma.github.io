---
layout: post
title: "docker execに-itをつけるとバックグラウンドで実行できない"
tags:
  - other
date: "2026/01/18"
---

Electrum server を動かしたいので [esploraのdockerコンテナ](https://blog.hirokuma.work/bitcoin/tools/esplora.html#docker%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A)を立ち上げた。
それなら electrs だろうが、と思われそうだが esplora の dockerコンテナは bitcoind と electrs(blockstreamの方) も立ち上がるのだ。

regtest なのでブロック生成には `generatetoaddress` を使うのだが定期的に実行したいのでスクリプトにした。
昔作っていた [generate.sh](https://gist.github.com/hirokuma/6a8d1553a813fa569599d5b0f54f722a#file-generate-sh) のコマンドを `docker exec` にすることで動いた。

動かし続けるのにコンソールを1つ立ち上げたままにするのももったいないので `&` を付けてバックグラウンドで動かそうとした。
が "Stopped" になって止まる。  
どうやら `watch` は標準出力に吐き出すコマンドなのにバックグラウンドにすると吐き出せなくなるからダメらしい(AI)。

では `while` に置き換えればうまくいくかというと、それもダメだった。
最初の ADDR=`$CLI getnewaddress` が既にダメらしい。  
`$CLI` は `docker exec` するスクリプトにしていた。中身はこう。

```bash
result=$(docker exec -it blockstream_esplora /bin/cli $@)
echo $result | tr -d '\r'
```

おしりの `tr` は、どうやら出力が改行コードも含めたものになってしまうのかスクリプトの戻り値を変数に代入して他のコマンドの引数にすると失敗するので取り除くためのものだ。
他の解決方法もあるのかもしれんが動いているのでそうしている。

ダメだった理由はタイトル通りで、`-it` をつけるとターミナルやらインタラクティブやらで入出力を使おうとするのでダメだったらしい。
これなら `&` をつけても動いた。

```bash
result=$(docker exec blockstream_esplora /bin/cli $@)
echo $result | tr -d '\r'
```
