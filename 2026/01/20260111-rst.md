---
layout: post
title: "rust: 関数ポインタ"
tags:
  - rust
date: "2026/01/12"
---

本を読んで、Rust にも関数ポインタがあることを知った。

* [Creating function pointers](https://doc.rust-lang.org/std/primitive.fn.html#creating-function-pointers)

シグネイチャが型になるのは他の言語とだいたい同じかな。  
比較はあまり使わないように思ったが、わざわざ関数が用意してあるので使い所があるのだろう。

この例の `op` は型を指定しているので `fn_addr_eq()` に何もせず与えられるが、直接 `sum` を代入した場合はダメらしい。
理由は[本](https://www.oreilly.co.jp/books/9784814400942/)に載っていたが、気になる人は買って読んでみるとよかろう。

```rust
use std::ptr::fn_addr_eq;

fn sum(x: i32, y:i32) -> i32 {
    x + y
}

fn main() {
    let op: fn(i32, i32) -> i32 = sum;
    assert!(op(1, 2) == 3);

    let op1 = op;
    let op2 = op;
    // assert!(op1 == op2);
    assert!(fn_addr_eq(op1, op2));

    let op1 = sum;
    let op2 = sum;
    assert!(fn_addr_eq(op1 as fn(i32, i32) -> i32, op2 as fn(i32, i32) -> i32));
}
```

## トレイトは無理そう

この間トレイトを使って同じようなことをやったのだが、関数ポインタがあるならトレイトを使わなくてもできるのでは？

* [rust: Commandパターンのような - hiro99ma blog](https://blog.hirokuma.work/2026/01/20260102-rst.html)

特定のメソッドについては関数ポインタにできるようだ。

```rust
impl Handler for Command1 {
    fn execute(&self, value: u32) -> Result<String> {
        Ok(format!("command1 = {value}"))
    }
}

let op: fn(&Command1, u32) -> Result<String> = <Command1 as Handler>::execute;
```

トレイトも同じようにできないかやってみたが、どうにも無理そうだった。  
前にやっていた `dyn` をつけて `Box<>` で囲むというあれが「トレイトオブジェクト」というものだそうだ。

* [Gemini](https://gemini.google.com/share/328cbd0070f1)

`async` も同じようにといってよいかわからないが使えないようだ。  
型として `op: async fn(...` というのがそもそもエラーになる。トレイトの時と同じように `Pin<Box<dyn Future<>>>` を使うそうだ。

```rust
use anyhow::Result;
use std::{time::Duration, pin::Pin, future::Future};
use tokio;

fn execute(value: u32) -> Pin<Box<dyn Future<Output = Result<String>> + Send + 'static>> {
    Box::pin(async move {
        tokio::time::sleep(Duration::from_secs(1)).await;
        Ok(format!("command1 = {value}"))
    })
}

#[tokio::main]
async fn main() -> Result<()> {
    let op: fn(value: u32) -> Pin<Box<dyn Future<Output = Result<String>> + Send + 'static>> = execute;
    println!("{}", op(3).await?);
    Ok(())
}
```

これも結局は関数ポインタになるのだろうか。
なるのだろうな。

この非同期関数の形ならクロージャにもできる。意味があるのかどうか知らんが。

```rust
use anyhow::Result;
use std::{time::Duration, pin::Pin, future::Future};
use tokio;

#[tokio::main]
async fn main() -> Result<()> {
    let op = |value: u32| -> Pin<Box<dyn Future<Output = Result<String>> + Send + 'static>> {
        Box::pin(async move {
            tokio::time::sleep(Duration::from_secs(1)).await;
            Ok(format!("command1 = {value}"))
        })
    };

    println!("{}", op(3).await?);
    Ok(())
}
```

前のコードをコピーしてきたので `+ Send + 'static` がついているが、なくてもエラーにならないし、あっても何も言われない。  
必要なときもある。

* [Gemini](https://gemini.google.com/share/8a6ef1467b89)

