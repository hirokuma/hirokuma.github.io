---
layout: post
title: "rust: match使いすぎ"
tags:
  - rust
create: "2026/02/16"
date: "2026/02/16"
---

Go言語で関数の戻り値を `(result, err)` にするように Rustでは `Result<T>` や `Option<T>` をしばしば使う。  
使うときに `?` で放り投げればよいときもあれば、ちゃんと判断しないといけないときもある。

そのとき `match` をいつも使っていたのだが、`cargo clippy` がたまに指摘して `match` を使わない書き方を提示してくる。
うそ。。。もしかして私 `match` 使いすぎ・・・？

## こういうのは指摘される

以前やったときは `match` の片方が空にしていたので、それなら `if let`でよいという指摘だった。

* [rust: cargo clippy は Option.mapを使えという - hiro99ma blog](https://blog.hirokuma.work/2025/12/20251208-rst.html#%E3%81%8A%E3%81%BE%E3%81%91)

```rust
// こういうのは...
match result_func() {
  Ok(v) {},
  Err(e) { error!("{}", e); }
}

// こうするとよいよ
if let Err(e) = result_func() {
  error!("{}", e);
}
```

しかし `if let Err(e) = ...` でよいのは戻り値を使わない場合だと思う。  
戻り値を使いたかったら `match` でやったほうが自然だろう。

## inspect_err(|e|)は便利そうなのだが

`.inspect_err(|e| ～)?` とすると、ログを吐いて戻る程度だとあまり記述せずに済む。  
気になるのは `.inspect_err()` をあまり見かけないことだ。  
登場が最近のことらしく、`map_err()` で同じ事ができたからそれを使っていたからじゃないかというのが Gemini氏の推測だ。

## Optionの場合

`Err(e)` はエラーと明言しているが `Option<T>` は値が有るか無いかなのでどっちに問題があるということはない。

`if let Some(v) = ...` か `if let v.is_none()` を使うのもありだが、
先程の `Result<T>` を思えば `match` でやるほうが自然なことも多そうだ。

## unwrap_or のような

エラーにせず、適当な値を返せばよいだけということもあるだろう。
未定義の場合は空文字列を返す、のようなことはしばしばある。

そういうときは `match` でやらずに `unwrap_なんとか` 系を使うと意図もわかりやすくてよいだろう。  
どっちでもいいやん、と `match` を使うと `cargo clippy` が指摘するということもしばしば。。。

## iter などで使う

`.iter().map(|item| ～)` のようなコードでクロージャに書くときはあまり長々書かずに `is_ok()` などを使うと良さそうだった。
条件に合うものだけ通すような書き方に向いているのかな。
