---
layout: post
title: "rpi: HDDの調子がよくないのでツールにチェックしてもらう"
tags:
  - linux
  - bitcoin
create: "2026/02/10"
date: "2026/02/10"
---

以前、Raspberry Pi4で `bitcoind` を動かすのにあれやこれやした。

* [btc: bitcoindのblocksを別ディレクトリにしたい - hiro99ma blog](https://blog.hirokuma.work/2025/04/20250402-btc.html)

ファイルを個別にSSDに置くなどして高速化を図っていたが、メンテナンスの手間が増えるだけなので `chainstate/` だけSSDに、それ以外はHDDに置いていた。

## 事の発端

年末年始があったのでRaspberry Pi4を止めていたのだが再起動するとelectrsが動いていない。  
エラーが出ていて、あるブロックのデータが取れないという。
`bitcoin-cli getblock` すると確かに取れない。その前後は取れる。  
こういうのは `bitcoind` の再起動でなんとかするんじゃないかと思ったのだがどうにもならない。

最終手段として `bitcoind -reindex` でインデックスの再生成を指示した。  
これが全然進まず・・・。2日目にようやく `getblockcount` で `0` 以外が返ってくるようになり、
3日目で1万ちょっとという進み具合。
4日目が2万になるかどうかだったので、このまま行くと数カ月かかってしまう。

さすがにそれはダメなのでRaspberry Pi4からノートPCにディスクをつなぎ直した。  
HDDがないと立ち上がらないような構成なのでドライブのチェックをするのに不向きだからだ。
また、多少は速くならないかという期待もある。
あったのだが、1日動かしてみてもブロック高の進み方はあまり変わらない。

余っているSSD... SMART でもう寿命宣言されたSSDがあったので `blocks/` をそちらに置いて同期が終わったらHDDに戻そうと考えた。  
そのファイル移動中に "Input/Output error" が出ていた。  
HDDもSSDも疑わしいのだが、ブロックのデータが読めなかった点を考えるとHDDの方があやしそうである。

買い替えるのがよいのはわかっている！  
わかっているのだが...やりたいことがなんでもできるわけではない。

## badblocks

不良セクタとかあるんじゃなかろうかということで `badblocks` で探して登録して使えないようにしてもらおう。  
手順はこんな感じらしい(ChatGPT)。  
いまは2行目の `badblocks` を実行しているのだが、1TB HDD で1時間実行して 6% 程度しか進んでいない。

```shell
$ sudo umount /dev/sdb1
$ sudo badblocks -sv /dev/sdb1 > badblocks.txt
$ sudo fsck.ext4 -l badblocks.txt /dev/sdb1
```

調べずに実行していたがオプションに破壊的検査もあるのか。。。あぶないところだった。  
`-w` が破壊的 R/W、`-n` が非破壊的 R/W、デフォルトは非破壊 Read-Onlyテストらしい。

* [badblocks - ArchWiki](https://wiki.archlinux.jp/index.php/Badblocks)
* [badblocks(8) - Linux manual page](https://www.man7.org/linux/man-pages/man8/badblocks.8.html)

## e2fsck

最近はAI記事ばかりなので多少古い方が信用できるときも多いよねー、と眺めていたら、
直接 `badblocks` を使うよりも `e2fsck` などを使うほうがよいようなことが書いてある。

* [Linux上でHDDの不良ブロックの確認を行う – 記録](https://www.ekesete.net/log/?p=4326)

確かに、↑ の badblocks(8) の "Important note" にもそういうことが書いてある。  
Ctrl+C で `badblocks` を中断して `e2fsck` に切り替えた。

```shell
$ sudo e2fsck -c /dev/sdb1
```

[-c](https://man7.org/linux/man-pages/man8/e2fsck.8.html) は `badblocks` を使うようにするオプションのようで、
実行すると `badblocks` と同じような進捗テキストが現れた。  
bad blockが見つかったらinodeをアロケーションから避けるようにするとも書いてあるので、これ1つでよいのだろう。

### その後

6時間で55%くらいだった。  
2.5インチのHDDだし、あんまり速くないと思う。

その前に実行していた `badblocks` の出力を見たのだが、10%も進んでいなかったのに300個以上も出力があった。。。  
もしかして、進捗テキストの "(xxxx/yyyy/zzzz error)" は "(よし / いまいち / だめ)" とかじゃなくて全部ダメなのか？  
Gemini を信用するなら "(読み取りエラー / 書き込みエラー / 比較エラー)" らしい。  
今やっている `e2fsck` で既に400あるよ。。。

これからHDDのbad blockは増えていく一方だろう。
それならSMARTで寿命扱いされたSSDに乗り換えたほうがマシなのか。  
Bitcoinフルノードの辛いところはブロックファイルを複数のドライブに分散するのが面倒なことだ。
シンボリックリンクなどを活用すればできるけど、ファイル単位でやっていくのが大変。

どうせRaspberry Pi4でしか使わないんだから、USBになった安めのSSDでもいいのかなあ。
安めと言っても十分高いんだが。  
あああ。。。
