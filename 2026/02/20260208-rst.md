---
layout: post
title: "rust: tracing_subscriberã®å‡ºåŠ›å…ˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ã™ã‚‹"
tags:
  - rust
create: "2026/02/08"
date: "2026/02/08"
---

Rustã§ãƒ­ã‚°å‡ºåŠ›ã•ã›ã¦ã„ã‚‹ã®ã ãŒã€ãã‚ãã‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«åãå‡ºã™ã®ã‚‚é™ç•Œã«ãªã£ã¦ããŸã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ãŸã„ã€‚  
`tokio::tracing` ã¨ã„ã†ã‚ˆã‚Šã¯ `tokio::tracing_subscriber` ãªã®ã‹ãªï¼Ÿ

* [tracing_subscriber - hiro99ma blog](https://blog.hirokuma.work/langs/rust/subscriber.html)

stderr ã«ã™ã‚‹ã®ã¯ `.with_writer(std::io::stderr)` ã§ç°¡å˜ã«ã§ããŸã®ã§åŒã˜ã‚ˆã†ãªæ°—æŒã¡ã§ã„ãŸã®ã ãŒã€
ãªã‹ãªã‹ã©ã†ã—ã¦ã€‚  
`tracing-appender` ãªã‚‹ã‚‚ã®ãŒã„ã‚‹ã‚‰ã—ã„ã€‚

* [deepwiki](https://deepwiki.com/search/_772d2576-65b0-4992-ab02-703b2338fe3d?mode=fast)

## ã‚µãƒ³ãƒ—ãƒ«ã©ãŠã‚Šã«

ã¾ãšã¯ã‚µãƒ³ãƒ—ãƒ«ã©ãŠã‚Šã«ã‚„ã£ã¦ã¿ã‚‹ã€‚

```toml
[dependencies]
tracing = "0.1.44"
tracing-appender = "0.2.4"
tracing-subscriber = "0.3.22"
```

```rust
use tracing::*;

fn main() {
    let file_appender = tracing_appender::rolling::hourly(".", "mylog.log");
    tracing_subscriber::fmt::Subscriber::builder()
        .with_writer(file_appender)
        .init();

    error!("error");
    warn!("warn");
    info!("info");
}
```

å®Ÿè¡Œã—ã¦ã‚‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã¯ä½•ã‚‚å‡ºåŠ›ã•ã‚Œãªã„ã€‚  
`mylog.log.2026-02-08-05` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œã‚‰ã‚Œã¦ä¸­ã«ãƒ­ã‚°ãŒå…¥ã£ã¦ã„ãŸã€‚  
ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚‚ãã®ã¾ã¾å…¥ã£ã¦ã„ã‚‹ã€‚

```log
[2m2026-02-08T05:19:32.870160Z[0m [31mERROR[0m [2mhello[0m[2m:[0m error
[2m2026-02-08T05:19:32.870196Z[0m [33m WARN[0m [2mhello[0m[2m:[0m warn
[2m2026-02-08T05:19:32.870203Z[0m [32m INFO[0m [2mhello[0m[2m:[0m info
```

## ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãªã—

`.with_ansi(false)` ã¨ã™ã‚‹ã¨è‰²ãŒã¤ã‹ãªããªã‚‹ã®ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚‚ãªããªã‚‹ã€‚

```rust
    tracing_subscriber::fmt::Subscriber::builder()
        .with_writer(file_appender)
        .with_ansi(false)
        .init();
```

ãƒ­ã‚°ã¯å·®åˆ†ã ã‘è¼‰ã›ãŸãŒã€å®Ÿéš›ã¯å‰å›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ã•ã‚Œã¦ã„ãŸã€‚
`rolling::hourly` ãªã®ã§æ™‚é–“ã”ã¨ã«ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚Œã‚‹ã®ã ã‚ã†ã€‚  
ãƒ•ã‚¡ã‚¤ãƒ«åã®å¾Œã‚ã«ã¤ã„ã¦ã„ã‚‹ `.2026-02-08-05` ã¯ã€ä»Šæ—¥ãŒ2026å¹´2æœˆ8æ—¥ã§ä»ŠãŒ14æ™‚ã™ã(JST)ã ã‹ã‚‰UTCã«ãªã£ã¦ `05` ãªã®ã ã‚ã†ã€‚

```log
2026-02-08T05:22:27.791418Z ERROR hello: error
2026-02-08T05:22:27.791506Z  WARN hello: warn
2026-02-08T05:22:27.791514Z  INFO hello: info
```

## logrotate

Linuxã® `logrotate` ã¨ã®ç›¸æ€§ã¯ã©ã†ãªã®ã ã‚ã†ã‹ã€‚
ã‚ã‚Œã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã¿ãŸã„ã«å˜ã«æ›¸ãå‡ºã—ã¦ã„ã‚‹ã ã‘ã§ã‚‚å¯¾å¿œã§ãã¦ã„ãŸã‚ˆã†ãªæ°—ãŒã™ã‚‹ã€‚
ã‚¢ãƒ—ãƒªãŒè‡ªåˆ†ã§ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã®ã‚‚ã‚ˆã„ã ã‚ã†ãŒã€å¤–éƒ¨ã«ä»»ã›ãŸã„å ´åˆã‚‚ã‚ã‚‹ã ã‚ã†ã€‚

* [Ubuntu Manpage: logrotate â€ rotates, compresses, and mails system logs](https://manpages.ubuntu.com/manpages/resolute/en/man8/logrotate.8.html)

### logrotateã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

æœ€çŸ­ã¯ `hourly` ãªã®ã§å®Ÿé¨“ã§è©¦ã™ã®ã¯ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ `--force` ã§è¡Œã†ã®ãŒè‰¯ã‹ã‚ã†ã€‚
ãªãŠ `tracing_appender::rolling` ã¯åˆ†å˜ä½ãŒæœ€çŸ­ã®ã‚ˆã†ã ã€‚

ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰confãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚Œã°ãã‚ŒãŒä½œå‹•ã™ã‚‹ã€‚  
ãŸã ã—ãã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ `root` ã‹ uid ãŒ `0` ã§ãªã„ã¨ã„ã‘ãªã„ã‚‰ã—ã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¬ãƒ™ãƒ«ã§å‹•ã‹ã™ã‚‚ã®ã§ã¯ãªã„ã¨ã„ã†ã“ã¨ã‹ã€‚

```conf
/home/xxx/rust/hello/mylog.log {
  rotate 12
  hourly
  compress
  missingok
  notifempty
}
```

### å®Ÿé¨“

`rolling::never` ã«ã—ã¦å‹•ã‹ã™ã¨ `mylog.log` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«åã§è¿½è¨˜ã•ã‚Œã¦ã„ã£ãŸã€‚

```rust
use tracing::*;

fn main() {
    let file_appender = tracing_appender::rolling::never(".", "mylog.log");
    let file_appender = RollingFileAppender::builder()  
        .rotation(Rotation::DAILY)  
        .filename_prefix("app")  
        .max_log_files(7) // 7ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§ä¿æŒ  
        .build("/var/log/myapp")?;

    tracing_subscriber::fmt::Subscriber::builder()
        .with_writer(file_appender)
        .with_ansi(false)
        .init();

    loop {
        error!("error");
        warn!("warn");
        info!("info");
        std::thread::sleep(std::time::Duration::from_secs(10));
    }
}
```

`logrotate` ã‚’å®Ÿè¡Œï¼

```shell
$ logrotate --force rotate.conf -s /dev/null
```

å®Ÿè¡Œã™ã‚‹ã¨ `.gz` ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œã‚‰ã‚Œã€`mylog.log` ã¯å‰Šé™¤ã•ã‚Œã€ã‚¢ãƒ—ãƒªã¯å‹•ã„ãŸã¾ã¾ã ãŒä»¥é™ã¯ `mylog.log` ãŒä½œã‚‰ã‚Œã‚‹ã“ã¨ã¯ãªã‹ã£ãŸã€‚  
ã‚„ã‚Šã‚ˆã†ã¯ã‚ã‚‹ã¿ãŸã„ã ãŒã€é¢å€’ãã†ã ã€‚

## ã‚¢ãƒ—ãƒªã§ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆ

`logrotate` ã¨ç›¸æ€§ãŒæ‚ªãã†ãªã®ã§ã‚¢ãƒ—ãƒªã§ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆã•ã›ã‚‹ã€‚

```rust
    let file_appender = tracing_appender::rolling::RollingFileAppender::builder()
        .rotation(tracing_appender::rolling::Rotation::MINUTELY)
        .filename_prefix("mylog") // å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹
        .max_log_files(3)
        .build("./logs") // ãƒ­ã‚°ã®ä¿å­˜å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        .unwrap();
```

ä¿å­˜å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã„ã¨ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã•ã‚Œã‚‹ãŒã€
çµ‚äº†ã›ãšã«ç¶šè¡Œã•ã‚ŒãŸã€‚

ã“ã‚Œã¯3ãƒ•ã‚¡ã‚¤ãƒ«ã§å›ã™ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã®ã ãŒã€
3ãƒ•ã‚¡ã‚¤ãƒ«ã‚ã‚‹çŠ¶æ…‹ã§ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã¨ä¸€ç•ªå¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¦2ãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã£ã¦é–‹å§‹ã•ã‚ŒãŸã€‚  
"Prune old files at startup" ã¨ã„ã†æŒ™å‹•ã ã¨ã®ã“ã¨ã€‚

* [appender: Prune old files at startup by kaffarell Â· Pull Request #2966 Â· tokio-rs/tracing](https://github.com/tokio-rs/tracing/pull/2966)

ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸€æ¯ã§æœ€å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½è¨˜å¯¾è±¡ã˜ã‚ƒãªã„ãªã‚‰å‰Šé™¤ã™ã‚‹ã®ã¯è‰¯ã„ã¨æ€ã†ã‘ã©ã€è¿½è¨˜ã§ãã‚‹ã®ã«å‰Šé™¤ã—ãªãã¦ã‚‚ã‚ˆã„ã®ã§ã¯ã€‚ã€‚  
ã—ã‹ã—ã¿ã‚“ãªãã®å‹•ä½œã«æ–‡å¥ã‚’è¨€ã£ã¦ã„ãªã„ã‚ˆã†ãªã®ã§ã€ä½•ã‹ç†ç”±ãŒã‚ã‚‹ã®ã ã‚ã†ã€‚  
å‰Šé™¤ã™ã‚‹ã®ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒã„ã£ã±ã„ãªã¨ãã ã‘ã®ã‚ˆã†ã§ã€é€£ç¶šã—ã¦ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ãƒ»çµ‚äº†ã¨ç¹°ã‚Šè¿”ã—ã¦ã‚‚ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒã©ã‚“ã©ã‚“å‰Šé™¤ã•ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã¯ãªã‹ã£ãŸã€‚
ãªã‚‰ã¾ã‚ã„ã„ã‹ã€‚
